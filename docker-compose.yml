services:
  proxy:
    image: ghcr.io/berriai/litellm:main-latest
    user: "${HOST_UID}:${HOST_GID}"
    cap_drop:
      - ALL
    env_file:
      - .secrets.env
    environment:
      - HOME=/tmp
      - LITELLM_NON_ROOT=true
      - LITELLM_MASTER_KEY=${DYNAMIC_AGENT_KEY}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Mount the config directly into /tmp
      - ./proxy_config.yaml:/tmp/config.yaml:ro
    # Tell LiteLLM to read the config from the new /tmp location
    command: ["--config", "/tmp/config.yaml"]
    networks:
      - agent_net

  agent:
    image: paulgauthier/aider-full
    depends_on:
      - proxy
    user: "${HOST_UID}:${HOST_GID}"
    cap_drop:
      - ALL
    environment:
      # We told Aider its home is /tmp...
      - HOME=/tmp
      - OPENAI_API_KEY=${DYNAMIC_AGENT_KEY}
    volumes:
      - ./src:/app/src:rw
      # ...so we mount the config file directly into its new home!
      - ./agent_settings.yml:/tmp/.aider.conf.yml:ro
      - ./prompts.md:/tmp/prompts.md:ro
    working_dir: /app/src
    networks:
      - agent_net
    stdin_open: true 
    tty: true

networks:
  agent_net:
    driver: bridge